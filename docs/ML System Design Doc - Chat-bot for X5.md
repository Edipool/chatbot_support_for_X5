# ML System Design Doc - Chat-bot for X5
---
# 1. Goals and prerequisites
----
## 1.1. Business Objectives
Этот проект призван решить проблему поиска ответа на вопрос. За время работы X5 накопилась огромная база знания с парами "вопрос-ответ". Руководство компании решило выставить на первую линию общения чат-бота вместо обращение к операторам. Если пользовать удовлетворен ответом на свой вопрос от чат-бота он не идет дальше на вторую линию к операторам, что в свою очередь снижает нагрузку и смещается акцент реагирования только на те вопросы, которых нет базе знаний.
## 1.2. Сoncept of the result
Схема верхнего уровня. Более подробную схему работы смотрите в пункте “Baseline”.
## 1.3. Existing flow analysis
На данный момент все вопросы адресуются на первую линию -- непосредственно на операторам.
## 1.4. Advantages of using ML
Мы предполагаем, что внедрение ML-решения и вынос его на первую линию снизит частоту обращения к операторам по ранее заданным и вопросам ответе на которые есть в наше базе знаний, что в свою очередь поможет сконцентрировать их внимание на более важных и не тривиальных кейсах, где требуется экспертиза живого человека.
## 1.5. Estimated Costs
Наш бюджет на инфраструктуру составляет 700 рублей в месяц. В эту сумму входит аренда сервера.
## 1.6. Business requirements and restrictions
### 1.6.1. Business requirements
**Доступность**: Сервис будет предоставляться в виде чата реализованного при помощи *Streamlit*. 
**Точность**: Бот должен предоставлять точные (в соответствии с конкретной метрикой, определенной в следующей главе) и релевантные ответа на вопрос пользователя.
### 1.6.2. Business restrictions
**Сроки**: Первая версия бота должна быть запущена в течение двух дней-трех дней.
### 1.6.3. MVP integration steps
**Предобработам датасет**: приведем к леме и стеме наши "вопросы-ответы", избавимся от дубликатов и спец символов.
**Сравнение алгоритмов поиска и моделей**: Обучим и сравним две модели *tf-idf* и *word2vec* и проведем сравнение двух алгоритмов поиска: косинусное расстояние и BM25.
**Логика дачи ответа**: пропишем условия для дачи ответа и переадресовки на оператора, если ответ неудовлетворил пользователя.  
**Написание UI**: напишем UI чата на Streamlit с возможностью оценки качества ответа для анализа ошибок.
**Деплой**: задеплоим сервис на сервер.
### 1.6.4. MVP Success criteria
**Функциональность поиска ответа на вопрос**: Бот должен точно и быстро отвечать на вопрос, предоставляя ответ.
**Время отклика**: Бот должен обрабатывать запросы и отображать результаты в течение 3-5 секунд.
**Удовлетворенность пользователей**: Положительные отзывы пользователей о простоте использования и полезности бота.
**Эксплуатационная надежность**: Бот должен надежно работать в тестовом режиме, сводя к минимуму сбои и ошибки.
## 1.7. Project Scope and Exclusions
### 1.7.1. Scope
1. Разработка и внедрение чат-бота, который позволяет пользователям находить ответы на свои вопросы, если они есть в базе знаний.
2. Создание алгоритма поиска ответа на вопрос. 
3. Разработка пользовательского интерфейса для обеспечения простого и интуитивно понятного взаимодействия с ботом.
4. Тестирование и оптимизация бота для обеспечения его надежности и эффективности
### 1.7.2. Exclusions
1. Использование CNN, LSTM, transformer, LLM, GPU, векторных баз данных.
---
# 2. Methodology
----
## 2.1. Defining the Problem
Основана проблема заключается в том, что ответы на уже заданные вопросы существуют в нашей базе знаний. Мы бы хотели дать возможность пользователю получить ответ на его вопрос в режиме чат-бота, тем самым мы бы сняли часть нагрузки с колл-центра и перенаправляли бы на операторов только тогда, когда пользователь не получил нужного ответа на свой вопрос.
## 2.2. Choosing metrics
### 2.2.1. Offline metrics
- **Precision (by tags)**. Мы ожидаем 0.80
### 2.2.2. Online metrics
**Visited**  - Количество пользователей, которые открыли чат-бота.
**Submitted**  - Количество пользователей, которые отправляют запрос.
**Switching to the operator** - Количество ответов от бота, которые не устроили пользователя и мы вывели ему контакты оператора.
### 2.2.3. Business metrics
**Number of requests to operators** - Количество обращений к оператору в день/неделю/месяц.
### 2.2.4. Technical metrics
**Задержка** - среднее время ответа на запрос пользователя
**Пропускная способность (TPC)** - количество запросов, обрабатываемых в секунду
**Надежность** - процент успешных запросов по сравнению с общим количеством запросов.
## 2.3. Defining Objects and Targets
В общем смысле наш таргет это колонка с ответом. Чтобы корректно считать *Precision (by tags)* и понимать улучшаем ли мы наш алгоритм мы обогатим наш датасет тегами к какой теме относиться вопрос и будем считать долю положительного класса среди всех предсказанных положительных классов, т.е. _Precision_.
## 2.4. Data collection.
Нам представлена база знаний с вопросом и ответом на него. 
## 2.5. Data preparation.
Мы избавимся от дубликатов, пропусков, спецсимволов, приведем слова к лемме и стемме, добавим теги при помощи разметчиков или GPT-4o
## 2.6. Error analysis
Мы будем предлагать пользователю оценить качество ответа чат-бота, чтобы можно было понять, где мы ошибаемся т.е. какие вопросы вызывают неправильный ответ с точки зрения пользователя, какие вопросы провоцируют пользователя идти дальше т.е. к оператору.
Все это поможет нам обогатить нашу базу знаний новыми парами "вопрос-ответ".

---
# 3. Pilot Training
---
## 3.1. Solution ML Architecture
### 3.1.1. Baseline
Добавить схему
### 3.1.2. Enhancements Post-Baseline
После удачного Baseline мы итеративно двинемся в сторону CNN, LSTM, Bert, добавим LLM с RAG, чтобы пользователь мог вести полноценный диалог с ботом.
## 3.2. Pre-Launch Quality Assurance
Перед запуском чат-бота мы проверим качество ответов, попросим внутренних пользователей оценить качество работы бота.
Мы будем считать, что выпуск чат-бота будет возможен при качестве *Precision* > 0.8 и если 3 из 4 внутренних пользователей положительно отзовутся о нашем боте.
## 3.3. Pilot Evaluation Method
Для оценки эффективности пилотного проекта мы будем использовать комбинацию качественных и количественных методов. Мы будем отслеживать такие показатели, как точность, отзывчивость и удовлетворенность пользователей, чтобы оценить актуальность ответов, возвращаемых системой. Качественная обратная связь также будет собрана с помощью опросов пользователей и интервью с акцентом на удобство использования и полезность бота в поиске подходящих проектных документов.
## 3.4. Criteria for a Successful Pilot.
Пилотный проект будет считаться успешным, если он соответствует следующим критериям:

**Precision**: *Precision* ответа составляет не менее 0.8.
**Время отклика**: Ответы системы должны быть получены в течение 3-5 секунд.
**Удовлетворенность пользователей**: Не более 30% пользователей пилотного проекта уходят за ответом к операторам.  
## 3.5. Infrastructure and Scalability Details
На пилотном этапе сервис будет использовать механизмы контейнеризации. Такой подход  гарантирует, что система является масштабируемой и способна обрабатывать растущий объем данных и запросы пользователей по мере расширения сервиса при помощи балансировщиков нагрузки, таки как K8S или его меньший аналог K3S.
## 3.6. Monitoring
Мониторинг будет сосредоточен на производительности и надежности системы. Такие показатели, как время ответа на запрос, время безотказной работы системы и частота ошибок, будут постоянно отслеживаться. Будет настроено обнаружение аномалий, чтобы предупреждать команду о любом необычном поведении или потенциальных сбоях системы.
## 3.7. Requirements for the operation of the system.
   - Ежедневное резервное копирование данных для предотвращения их потери.
## 3.8. System security.
### 3.8.1. Data Encryption
Мы будем использовать HTTPS для безопасной передачи данных и шифровать сохраненные данные для предотвращения несанкционированного доступа. 
### 3.8.2. Authentication and Access Controls
Доступ к административным функциям будет ограничен для авторизованного персонала с помощью строгих мер аутентификации.
### 3.8.3. Credential Security
Мы закроем все открытые порты от Docker для предотвращения атак через открытые порты, на этапе первого подъема контейнера с базами данных и любыми иными сервисами мы будем использовать НЕ ДЕФОЛТНЫЕ ПАРОЛИ, а сразу сменим их на сложные шестнадцатизначные. 

А также избегаем импортирование кредов в env с последующей публикацией с репозиторий независимости он будет открытым или закрытым.
## 3.9. Risks
### 3.9.1. Data Quality
**Проблема**: Неточные или неполные ответы, которые содержаться в нашей базе знаний могут значительно снизить эффективность алгоритмов поиска, что приводит к даче ошибочных ответов.
**Профилактические меры**: Внедрите строгие процедуры проверки того, что у нас содержится в базе знаний.
### 3.9.2. Model Overfitting
**Проблема**: Учитывая небольшой размер набора данных, существует риск того, что модель (word2vec) может переобучиться на тренировочных данных, что приведет к плохому обобщению новых данных.
**Профилактические меры**: подбор оптимальных гиперпараметров.
### 3.9.3. User Engagement
**Проблема**: Существует риск того, что чат-бот может оказаться не таким привлекательным для пользователей, как ожидалось, что приведет к снижению активности и обратной связи.
**Профилактические меры**: Разработать интерактивный и интуитивно понятный пользовательский интерфейс и регулярно обновляйте контент и функции на основе отзывов пользователей.
### 3.9.4. System Performance and Scalability
**Проблема**: По мере роста базы пользователей и объема данных могут возникнуть проблемы с производительностью и масштабируемостью системы. 
**Профилактические меры**: Используйте масштабируемую облачную инфраструктуру, оптимизируйте алгоритмы поиска и базы данных для эффективной обработки больших объемов данных и балансировщик нагрузки.
### 3.9.5. Technical Issues and Bugs
**Проблема**: Потенциальные технические сбои и ошибки программного обеспечения могут негативно повлиять на работу системы на этапе тестирования. 
**Профилактические меры**: Проведите тщательное тестирование перед запуском, включая модульное тестирование, интеграционные тесты и стресс-тесты, а также настройте системы мониторинга для быстрого выявления и исправления ошибок.

---
# 4. Pilot implementation.
---
## 4.1. MVP Implementation Phases
Пилотное внедрение будет включать в себя ограниченный выпуск для небольшой группы пользователей для тестирования и получения отзывов. Это позволит нам оценить производительность и удобство использования сервиса в реальных условиях перед полномасштабным запуском.
### 4.1.1. Prototyping and preliminary experiment.
Разработаем первую базовую версию алгоритма поиска ответа на вопрос:

1. Реализуем базовый алгоритм, который может сопоставлять вопрос пользователя с ответом.
2. Замерим качество на тестовых вопросах.
3. Оценим эффективность алгоритма, используя метрик из раздела 2.2.
4. Соберите первоначальные отзывы небольшой группы пользователей как это описано в разделе 3.2 
### 4.1.2. Scaling based on experimental data.
### 4.1.3. Testing
Проведем тщательное тестирование функциональности бота:

1. Выполним модульные тесты для проверки отдельных компонентов и функций алгоритма поиска и интерфейса.
2. Проведем интеграционные тесты, чтобы убедиться, что различные компоненты системы работают вместе без сбоев.
3. Выполним комплексные тесты для моделирования реальных пользовательских сценариев и проверки общей производительности системы.

Устраним любые выявленные проблемы и оптимизируем систему для повышения производительности:

1. Отладим и исправим любые проблемы или баги, выявленные в процессе тестирования.
2. Оптимизируем производительность системы, отладив алгоритмы, улучшив стратегии кэширования или модернизировав инфраструктуру по мере необходимости.

Проведем тестирование на ограниченном круге пользователей:

1. Продемонстрируем нашего чат-бота 5 экспертам, как это описано в разделе 3.2.
2. Внедрим механизмы сбора отзывов, такие как выставление оценки ответу бота.
4. Устраним все оставшиеся проблемы перед запуском MVP.

Если система соответствует критериям, указанным в пункте 3.3, приступим к запуску MVP.
### 4.1.4. MVP Launch
1. Настроим необходимую инфраструктуру и ресурсы для размещения бота и связанных с ним данных.
2. Настроим инструменты мониторинга и ведения журнала для отслеживания производительности бота и вовлеченности пользователей.
3. Будем быстро реагировать и устранять любые критические проблемы или баги, с которыми пользователи могут столкнуться при использовании бота.
4. Постоянно будем улучшать систему на основе отзывов пользователей и показателей производительности.
### 4.1.5. Analysis feedback
Проанализируем обратную связь с отрицательными оценками, чтобы определить области для улучшения и добавление новых пар вопрос-ответ.